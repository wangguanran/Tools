# 日志解析工具 v1.3.3

## 功能说明
1. 自动解压`.zip`和`.gz`文件，保持原始文件名，已解压的文件会被跳过
2. 递归搜索指定目录下的kernel相关日志
3. 过滤并排序充电相关日志，使用正则表达式匹配关键词（`cx2560x`、`sprdbat`、`sprdchg`、`battery`等），结果保存到`charge.log`
4. 解析cx2560x充电IC寄存器信息，支持以下寄存器：
   - **寄存器0x00**：输入电流限制设置
   - **寄存器0x01**：系统配置和最小电压设置
   - **寄存器0x02**：快速充电电流设置
     * `BOOST_LIM`: Boost模式电流限制（0.5A/1.2A）
     * `Q1_FULLON`: Q1 MOSFET控制模式
     * `ICHG[5:0]`: 快速充电电流设置
       - `000000~001101`: 0mA~1170mA, 90mA per step
       - `001110~110101`: 805mA~3047.5mA, 57.5mA per step
   - **寄存器0x03**：预充电和终止电流设置
     * `IPRECHG[3:0]`: 预充电电流设置
       - 偏移值: 52mA
       - 步进值: 52mA/step
       - 范围: 52mA~676mA
     * `ITERM[3:0]`: 充电终止电流设置
       - 偏移值: 60mA
       - 步进值: 60mA/step
       - 范围: 60mA~780mA
   - **寄存器0x04**：充电电压设置
     * `VREG[5:0]`: 充电电压设置
       - 偏移值: 3.856V
       - 步进值: 32mV/step
       - 范围: 3.856V~4.624V
       - 默认值: 4.208V (01011)
     * `Reserved[1:0]`: 保留位

## 使用说明
### 1. 安装依赖
- 所有依赖均为Python标准库，无需额外安装

### 2. 运行脚本
将脚本放在日志文件所在目录，运行以下命令：
```bash
# 仅解压文件
python parse.py

# 输出充电日志
python parse.py --output-charge-log

# 解析cx2560x寄存器
python parse.py --parse-charger-cx2560x

# 同时执行多个功能
python parse.py --output-charge-log --parse-charger-cx2560x
```

## 命令行参数
| 参数 | 说明 |
|------|------|
| `--output-charge-log` | 输出充电日志到`charge.log`，从kernel日志中搜索并按时间戳排序 |
| `--parse-charger-cx2560x` | 解析cx2560x寄存器信息，支持用户输入寄存器值进行解析。解析结果将保存在`cx2560x`目录下，文件名包含时间戳 |

## 输出文件
1. `charge.log`：包含所有匹配的充电相关日志，按时间戳排序
2. `cx2560x/registers_YYYYMMDD_HHMMSS.txt`：包含寄存器解析结果，每次运行生成新文件

## 主要功能详解
### 1. 自动解压缩文件
- 支持`.zip`扩展名的gzip压缩文件
- 支持标准zip压缩文件
- 自动检测文件类型并使用适当的解压方法
- 保持原始文件名（移除.zip扩展名）
- 自动跳过已解压的文件

### 2. Kernel日志搜索
- 递归搜索目录中的kernel相关日志
- 自动识别包含"kernel"的目录
- 列出所有找到的kernel日志文件

### 3. 充电日志筛选和排序
- 仅在kernel目录下的日志文件中查找
- 使用正则表达式匹配充电相关日志
- 支持的关键词：`cx2560x`、`sprdbat`、`sprdchg`、`battery`
- 自动解析日志时间戳
- 按时间顺序排序
- 将筛选结果保存到`charge.log`文件

### 4. cx2560x充电IC寄存器解析
- 自动检测是否使用cx2560x充电IC
- 解析充电IC寄存器信息
- 根据日志中的寄存器值进行分析

## 注意事项
1. 确保有足够的磁盘空间用于解压文件
2. 确保对目标目录有读写权限
3. 如果文件正在被其他程序使用，可能会导致解压失败
4. 脚本会保留原始文件，解压后的文件会去除.zip扩展名
5. 日志时间戳解析默认使用当前年份
6. 充电相关日志只在kernel目录下的日志文件中查找
7. 已解压的文件不会重复解压
8. cx2560x充电IC检测基于日志中的`cx2560x_init`关键字
9. 解析cx2560x寄存器信息需要先生成`charge.log`文件

## 错误处理
- 脚本包含详细的错误处理和日志输出
- 对于每个处理的文件都会显示：
  * 文件大小
  * 处理状态
  * 如果出错，会显示详细的错误信息

## 系统要求
- Python 3.x
- 所有依赖都是Python标准库，无需额外安装

## 版本历史
| 版本 | 更新内容 |
|------|----------|
| v1.3.3 | 添加寄存器0x04的解析功能 |
| v1.3.2 | 添加寄存器0x03的解析功能 |
| v1.3.1 | 修正寄存器0x02的快速充电电流计算 |
| v1.3.0 | 添加命令行参数支持 |
| v1.2.0 | 添加cx2560x寄存器解析功能 |
| v1.1.0 | 添加日志过滤和排序功能 |
| v1.0.0 | 初始版本，支持文件解压 | 